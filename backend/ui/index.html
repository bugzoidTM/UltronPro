<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UltronPRO ‚Äî Dashboard</title>
  <meta name="description" content="UltronPRO AGI - Processador de Curiosidade Adaptativo" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0e17;
      --bg-secondary: #111827;
      --bg-card: #1a2332;
      --bg-hover: #243044;
      --border: #2d3a4f;
      --border-active: #4f6b8f;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent-blue: #3b82f6;
      --accent-purple: #8b5cf6;
      --accent-green: #10b981;
      --accent-orange: #f59e0b;
      --accent-red: #ef4444;
      --accent-cyan: #06b6d4;
      --gradient-1: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      --gradient-2: linear-gradient(135deg, #10b981 0%, #06b6d4 100%);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.4);
      --radius: 12px;
      --radius-sm: 8px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* Header */
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(12px);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: var(--gradient-1);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 800;
    }

    .logo-text {
      font-size: 20px;
      font-weight: 700;
      background: var(--gradient-1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .phase-badge {
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      background: var(--bg-secondary);
      padding: 8px 24px;
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
    }

    .tab {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      padding: 10px 20px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .tab:hover { background: var(--bg-hover); color: var(--text-primary); }
    .tab.active { 
      background: var(--bg-card); 
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    /* Main content */
    .main { padding: 24px; max-width: 1600px; margin: 0 auto; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Grid layouts */
    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title .icon { font-size: 16px; }
    .card-body { padding: 20px; }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      background: var(--gradient-1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .stat-value.green { background: var(--gradient-2); -webkit-background-clip: text; background-clip: text; }
    .stat-label { font-size: 12px; color: var(--text-muted); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

    /* Forms */
    textarea, input[type="text"], input[type="search"] {
      width: 100%;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      padding: 12px 16px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      transition: border-color 0.2s;
    }

    textarea:focus, input:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    /* Buttons */
    .btn {
      background: var(--gradient-1);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59,130,246,0.4); }
    .btn:active { transform: translateY(0); }
    
    .btn-secondary {
      background: var(--bg-hover);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover { background: var(--bg-card); box-shadow: none; }

    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-danger { background: var(--accent-red); }

    .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

    /* Graph container */
    #graph {
      height: 500px;
      border-radius: var(--radius);
      background: var(--bg-secondary);
      border: 1px solid var(--border);
    }

    /* Lists */
    .list-item {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      transition: background 0.2s;
    }
    .list-item:last-child { border-bottom: none; }
    .list-item:hover { background: var(--bg-hover); }

    /* Trust bar */
    .trust-bar {
      height: 6px;
      background: var(--bg-secondary);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 8px;
    }

    .trust-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s;
    }

    .trust-high { background: var(--accent-green); }
    .trust-medium { background: var(--accent-orange); }
    .trust-low { background: var(--accent-red); }

    /* Tags */
    .tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tag-blue { background: rgba(59,130,246,0.15); color: var(--accent-blue); }
    .tag-purple { background: rgba(139,92,246,0.15); color: var(--accent-purple); }
    .tag-green { background: rgba(16,185,129,0.15); color: var(--accent-green); }
    .tag-orange { background: rgba(245,158,11,0.15); color: var(--accent-orange); }
    .tag-red { background: rgba(239,68,68,0.15); color: var(--accent-red); }

    /* Question box */
    .question-box {
      background: linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(139,92,246,0.1) 100%);
      border: 1px solid var(--accent-blue);
      border-radius: var(--radius);
      padding: 20px;
    }

    .question-text {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    /* Feed */
    .feed {
      max-height: 300px;
      overflow-y: auto;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      padding: 12px;
    }

    .feed-item {
      padding: 4px 0;
      color: var(--text-secondary);
    }

    .feed-item .time { color: var(--text-muted); }
    .feed-item .kind { color: var(--accent-cyan); }

    /* Conflict card */
    .conflict-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
    }

    .conflict-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .variant-option {
      display: block;
      padding: 10px 12px;
      margin: 6px 0;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
    }

    .variant-option:hover { border-color: var(--accent-blue); }
    .variant-option input { margin-right: 10px; }

    /* Effectiveness bar */
    .eff-bar {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .eff-bar-track {
      flex: 1;
      height: 8px;
      background: var(--bg-secondary);
      border-radius: 4px;
      overflow: hidden;
    }

    .eff-bar-fill {
      height: 100%;
      background: var(--gradient-2);
      border-radius: 4px;
      transition: width 0.3s;
    }

    .eff-value {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent-green);
      min-width: 40px;
      text-align: right;
    }

    /* Search results */
    .search-result {
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
    }

    .search-score {
      font-size: 11px;
      color: var(--accent-cyan);
      font-weight: 600;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 12px 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    .toast.success { border-color: var(--accent-green); }
    .toast.error { border-color: var(--accent-red); }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Muted text */
    .muted { color: var(--text-muted); font-size: 12px; }
    .mono { font-family: 'JetBrains Mono', monospace; }

    /* Code */
    code {
      background: var(--bg-secondary);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: var(--accent-cyan);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .grid-2 { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .header { padding: 12px 16px; }
      .main { padding: 16px; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <div class="logo-icon">U</div>
      <span class="logo-text">UltronPRO</span>
    </div>
    <div class="phase-badge" id="phaseBadge">üßí Fase 1 ‚Äî Beb√™ (AGI 0%)</div>
  </header>

  <!-- Tabs -->
  <nav class="tabs">
    <button class="tab active" data-tab="overview">üìä Overview</button>
    <button class="tab" data-tab="teach">üéì Ensinar</button>
    <button class="tab" data-tab="graph">üß† Grafo</button>
    <button class="tab" data-tab="sources">üîí Fontes & Trust</button>
    <button class="tab" data-tab="curiosity">üîÆ Curiosidade</button>
    <button class="tab" data-tab="conflicts">‚ö° Conflitos</button>
    <button class="tab" data-tab="search">üîç Busca</button>
    <button class="tab" data-tab="insights">üí° Insights</button>
    <button class="tab" data-tab="settings">‚öôÔ∏è Config</button>
  </nav>

  <!-- Main content -->
  <main class="main">
    <!-- Overview Tab -->
    <div id="tab-overview" class="tab-content active">
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card"><div class="stat-value" id="statExp">-</div><div class="stat-label">Experi√™ncias</div></div>
        <div class="stat-card"><div class="stat-value" id="statTriples">-</div><div class="stat-label">Triplas</div></div>
        <div class="stat-card"><div class="stat-value green" id="statAnswered">-</div><div class="stat-label">Respondidas</div></div>
        <div class="stat-card"><div class="stat-value" id="statOpen">-</div><div class="stat-label">Perguntas Abertas</div></div>
        <div class="stat-card"><div class="stat-value" id="statSources">-</div><div class="stat-label">Fontes</div></div>
        <div class="stat-card"><div class="stat-value green" id="statConflicts">-</div><div class="stat-label">Conflitos</div></div>
      </div>
      <div class="card" style="margin-bottom: 20px;">
        <div class="card-body" style="padding: 12px 16px;">
          <div class="muted" id="autonomyOps">Autonomia: carregando...</div>
          <div class="muted" id="reqScores" style="margin-top:8px">Requisitos 1-8: carregando...</div>
          <div class="muted" id="sprint2Health" style="margin-top:8px">Sprint 2: carregando...</div>
          <div id="conflictsPreview" class="muted" style="margin-top:10px">Conflitos: carregando...</div>
          <div id="missionPreview" class="muted" style="margin-top:10px">Mission Control: carregando...</div>
        </div>
      </div>

      <div class="grid-2" style="margin-bottom: 20px;">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><span class="icon">üéØ</span> Curr√≠culo da Ambi√ß√£o (Goal Ativo)</div>
            <button class="btn btn-sm btn-secondary" onclick="loadGoalCurriculum()">üîÑ Refresh</button>
          </div>
          <div class="card-body">
            <div id="goalCurriculum" class="muted">(carregando...)</div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title"><span class="icon">üß†</span> Teoria da Mente (Intento do Usu√°rio)</div>
            <button class="btn btn-sm btn-secondary" onclick="loadTomStatus()">üîÑ Refresh</button>
          </div>
          <div class="card-body">
            <div id="tomIntent" class="muted">(carregando...)</div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
          <div class="card-title"><span class="icon">üß≠</span> Miss√£o de Longo Horizonte</div>
          <button class="btn btn-sm btn-secondary" onclick="loadHorizonStatus()">üîÑ Refresh</button>
        </div>
        <div class="card-body">
          <div id="horizonMission" class="muted">(carregando...)</div>
        </div>
      </div>

      <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
          <div class="card-title"><span class="icon">üé≠</span> Persona Runtime</div>
          <button class="btn btn-sm btn-secondary" onclick="loadPersonaStatus()">üîÑ Refresh</button>
        </div>
        <div class="card-body">
          <div id="personaStatus" class="muted">(carregando...)</div>
          <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
            <input id="personaTone" type="text" placeholder="tone (ex: direct,auditable)" style="flex:1; min-width:220px;">
            <input id="personaFewShot" type="number" min="1" max="6" value="3" style="width:90px;">
            <button class="btn btn-sm" onclick="savePersonaConfig()">üíæ Salvar</button>
          </div>
          <div style="margin-top:8px;" class="muted">Top exemplos por score:</div>
          <div id="personaExamples" class="muted" style="margin-top:6px"></div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><span class="icon">‚ùì</span> Pr√≥xima Pergunta</div>
            <button class="btn btn-sm btn-secondary" onclick="refreshQuestions()">üîÑ Refresh</button>
          </div>
          <div class="card-body">
            <div id="questionBox" class="question-box">
              <div class="question-text" id="questionText">(nenhuma pergunta)</div>
              <div class="muted" id="questionMeta"></div>
            </div>
            <div style="margin-top: 16px">
              <textarea id="answerInput" rows="4" placeholder="Digite sua resposta..."></textarea>
            </div>
            <div class="btn-group" style="margin-top: 12px">
              <button class="btn" onclick="submitAnswer()">‚úì Responder</button>
              <button class="btn btn-secondary" onclick="skipQuestion()">‚Üí Pular</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title"><span class="icon">üìú</span> Feed de Aprendizado</div>
          </div>
          <div class="card-body">
            <div class="feed" id="feed">(aguardando eventos...)</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Teach Tab -->
    <div id="tab-teach" class="tab-content">
      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><span class="icon">üìù</span> Ingerir Experi√™ncia</div>
          </div>
          <div class="card-body">
            <textarea id="expInput" rows="8" placeholder="Cole aqui o que voc√™ quer ensinar... pode ser texto, fatos, defini√ß√µes, regras, etc."></textarea>
            <div style="margin-top: 12px; display: flex; gap: 12px; flex-wrap: wrap;">
              <input type="text" id="sourceInput" placeholder="Fonte (ex: wikipedia, voc√™)" style="flex: 1; min-width: 150px;">
              <select id="modalityInput" style="padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                <option value="text">Texto</option>
                <option value="law">Lei/Norma</option>
                <option value="definition">Defini√ß√£o</option>
                <option value="fact">Fato</option>
              </select>
            </div>
            <div class="btn-group" style="margin-top: 16px">
              <button class="btn" onclick="ingestExperience()">üì• Ingerir</button>
            </div>
            <div id="ingestMsg" class="muted" style="margin-top: 12px"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title"><span class="icon">üì§</span> Upload de Arquivo</div>
          </div>
          <div class="card-body">
            <input type="file" id="fileInput" style="margin-bottom: 12px;">
            <button class="btn btn-secondary" onclick="uploadFile()">üìÅ Upload</button>
            <div id="uploadMsg" class="muted" style="margin-top: 12px"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Graph Tab -->
    <div id="tab-graph" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title"><span class="icon">üß†</span> Grafo de Conhecimento</div>
          <div class="muted" id="graphStats">n√≥s=0 arestas=0</div>
        </div>
        <div class="card-body">
          <div class="muted" style="margin-bottom: 12px">
            <span class="tag tag-blue">Fatos</span>
            <span class="tag tag-purple">Normas (AGI)</span>
            <span class="tag tag-orange">Conflitos</span>
          </div>
          <div id="graph"></div>
        </div>
      </div>
    </div>

    <!-- Sources Tab -->
    <div id="tab-sources" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title"><span class="icon">üîí</span> Fontes & Governan√ßa de Confian√ßa</div>
          <button class="btn btn-sm btn-secondary" onclick="loadSources()">üîÑ Refresh</button>
        </div>
        <div class="card-body">
          <div class="muted" style="margin-bottom: 16px">
            Confian√ßa calculada via Jeffreys prior: (support+1)/(support+contradict+2). Fontes com muitas contradi√ß√µes perdem trust automaticamente.
          </div>
          <div id="sourcesList"></div>
        </div>
      </div>
    </div>

    <!-- Curiosity Tab -->
    <div id="tab-curiosity" class="tab-content">
      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><span class="icon">üîÆ</span> Sistema Adaptativo</div>
            <button class="btn btn-sm btn-secondary" onclick="loadCuriosityStats()">üîÑ Refresh</button>
          </div>
          <div class="card-body">
            <div class="stats-grid" style="margin-bottom: 0">
              <div class="stat-card"><div class="stat-value" id="curTemplates">-</div><div class="stat-label">Templates</div></div>
              <div class="stat-card"><div class="stat-value" id="curConcepts">-</div><div class="stat-label">Conceitos</div></div>
              <div class="stat-card"><div class="stat-value green" id="curDefined">-</div><div class="stat-label">Definidos</div></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title"><span class="icon">üï≥Ô∏è</span> Lacunas de Conhecimento</div>
          </div>
          <div class="card-body">
            <div id="gapsList" class="muted">(carregando...)</div>
            <div style="margin-top:12px">
              <button class="btn btn-sm btn-secondary" onclick="refreshQuestions()">‚ûï Gerar perguntas</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: 20px">
        <div class="card-header">
          <div class="card-title"><span class="icon">üì¨</span> Fila Adaptativa de Perguntas</div>
          <button class="btn btn-sm btn-secondary" onclick="loadCuriosityQueue()">üîÑ Refresh</button>
        </div>
        <div class="card-body">
          <div id="curQueueList"></div>
        </div>
      </div>

      <div class="card" style="margin-top: 20px">
        <div class="card-header">
          <div class="card-title"><span class="icon">üìä</span> Efic√°cia dos Templates</div>
        </div>
        <div class="card-body">
          <div id="templatesList"></div>
        </div>
      </div>
    </div>

    <!-- Conflicts Tab -->
    <div id="tab-conflicts" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title"><span class="icon">‚ö°</span> Conflitos Abertos</div>
          <div class="btn-group">
            <button class="btn btn-sm" onclick="autoResolveConflicts()">ü§ñ Auto-resolver</button>
            <button class="btn btn-sm btn-secondary" onclick="loadConflicts()">üîÑ Refresh</button>
          </div>
        </div>
        <div class="card-body">
          <div class="muted" style="margin-bottom: 16px">
            <strong>ü§ñ Auto-resolver:</strong> A LLM analisa as evid√™ncias e decide automaticamente.<br>
            <strong>üë§ Manual:</strong> Escolha a variante correta abaixo. Isso ajusta a confian√ßa das fontes.
          </div>
          <div id="autoResolveStatus" style="display: none; margin-bottom: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;"></div>
          <div id="conflictsList"></div>
          <div id="conflictsMsg" class="muted" style="margin-top: 12px"></div>
        </div>
      </div>
    </div>

    <!-- Search Tab -->
    <div id="tab-search" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title"><span class="icon">üîç</span> Busca Sem√¢ntica</div>
        </div>
        <div class="card-body">
          <div style="display: flex; gap: 12px;">
            <input type="search" id="searchInput" placeholder="Buscar no conhecimento..." style="flex: 1;">
            <button class="btn" onclick="doSearch()">Buscar</button>
          </div>
          <div id="searchResults" style="margin-top: 20px"></div>
        </div>
      </div>
    </div>

    <!-- Insights Tab -->
    <div id="tab-insights" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title"><span class="icon">üí°</span> Notifica√ß√µes & Insights da AGI</div>
          <div class="btn-group">
            <input type="search" id="insightSearch" placeholder="Buscar insights..." style="width:220px;">
            <button class="btn btn-sm btn-secondary" onclick="loadInsights()">üîÑ Refresh</button>
          </div>
        </div>
        <div class="card-body">
          <div class="muted" style="margin-bottom: 12px;">Canal de voz ativa do UltronPRO. Aqui ficam descobertas e atualiza√ß√µes feitas automaticamente.</div>
          <div id="insightsList"></div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="tab-settings" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title"><span class="icon">‚öôÔ∏è</span> Configura√ß√µes de API</div>
        </div>
        <div class="card-body">
          <div class="muted" style="margin-bottom: 20px;">
            Configure suas chaves de API para ativar a extra√ß√£o de triplas, perguntas de curiosidade e resolu√ß√£o de conflitos.
          </div>
          <form id="settingsForm">
            <div style="margin-bottom: 16px;">
              <label style="display:block; font-weight:600; margin-bottom:6px; color:var(--text-primary);">OpenAI API Key (gpt-4o-mini)</label>
              <input type="password" name="openai_api_key" placeholder="sk-..." style="font-family:monospace;">
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="display:block; font-weight:600; margin-bottom:6px; color:var(--text-primary);">Anthropic API Key (Claude 3.5 Sonnet)</label>
              <input type="password" name="anthropic_api_key" placeholder="sk-ant-..." style="font-family:monospace;">
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="display:block; font-weight:600; margin-bottom:6px; color:var(--text-primary);">Groq API Key (Llama 3 70B - R√°pido & Barato)</label>
              <input type="password" name="groq_api_key" placeholder="gsk_..." style="font-family:monospace;">
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="display:block; font-weight:600; margin-bottom:6px; color:var(--text-primary);">DeepSeek API Key (Racioc√≠nio Profundo)</label>
              <input type="password" name="deepseek_api_key" placeholder="sk-..." style="font-family:monospace;">
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="display:block; font-weight:600; margin-bottom:6px; color:var(--text-primary);">LightRAG API Key (Mem√≥ria Externa)</label>
              <input type="password" name="lightrag_api_key" placeholder="..." style="font-family:monospace;">
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="display:block; font-weight:600; margin-bottom:6px; color:var(--text-primary);">LightRAG URL</label>
              <input type="text" name="lightrag_url" placeholder="http://..." style="font-family:monospace;">
            </div>
            
            <button type="submit" class="btn" style="margin-top: 8px;">üíæ Salvar Configura√ß√µes</button>
          </form>
        </div>
      </div>
    </div>
  </main>

  <div id="toast" class="toast" style="display: none"></div>

  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <script>
    // === Tab Management ===
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
        
        // Load data for specific tabs
        if (tab.dataset.tab === 'graph') initGraph();
        if (tab.dataset.tab === 'sources') loadSources();
        if (tab.dataset.tab === 'curiosity') { loadCuriosityStats(); loadCuriosityQueue(); }
        if (tab.dataset.tab === 'conflicts') loadConflicts();
        if (tab.dataset.tab === 'insights') loadInsights();
        if (tab.dataset.tab === 'settings') loadSettings();
      });
    });

    // === Toast ===
    function showToast(msg, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = 'toast ' + type;
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 3000);
    }

    // === API ===
    async function api(url, opts = {}) {
      const timeoutMs = opts.timeoutMs || 12000;
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeoutMs);
      try {
        const r = await fetch(url, { ...opts, signal: controller.signal });
        const j = await r.json();
        if (!r.ok) throw new Error(j.detail || 'Error');
        return j;
      } finally {
        clearTimeout(timer);
      }
    }

    // === Status & Questions ===
    let currentQ = null;

    let _statusTick = 0;
    async function loadStatus() {
      try {
        _statusTick += 1;
        const slowCycle = (_statusTick % 4) === 0; // ~20s when base is 5s

        // Fast endpoints (frequent)
        const [st, aut] = await Promise.all([
          api('/api/status', { timeoutMs: 8000 }),
          api('/api/autonomy/status', { timeoutMs: 8000 }),
        ]);

        // Slow endpoints (batched less frequently)
        let mem = window.__memCache || {};
        let meta = window.__metaCache || {};
        let bench = window.__benchCache || { history: [], avg_score: 0 };
        let benchStatus = window.__benchStatusCache || {};
        let sprint2 = window.__sprint2Cache || {};

        if (slowCycle || !window.__memCache) {
          const slowResults = await Promise.allSettled([
            api('/api/memory/status', { timeoutMs: 8000 }),
            api('/api/metacognition/status', { timeoutMs: 8000 }),
            api('/api/agi/benchmark/trend?limit=7', { timeoutMs: 10000 }),
            api('/api/agi/benchmark/status', { timeoutMs: 10000 }),
            api('/api/sprint2/health', { timeoutMs: 10000 }),
          ]);
          mem = slowResults[0].status === 'fulfilled' ? slowResults[0].value : mem;
          meta = slowResults[1].status === 'fulfilled' ? slowResults[1].value : meta;
          bench = slowResults[2].status === 'fulfilled' ? slowResults[2].value : bench;
          benchStatus = slowResults[3].status === 'fulfilled' ? slowResults[3].value : benchStatus;
          sprint2 = slowResults[4].status === 'fulfilled' ? slowResults[4].value : sprint2;
          window.__memCache = mem;
          window.__metaCache = meta;
          window.__benchCache = bench;
          window.__benchStatusCache = benchStatus;
          window.__sprint2Cache = sprint2;
        }

        document.getElementById('statExp').textContent = st.stats?.experiences || 0;
        document.getElementById('statTriples').textContent = st.stats?.triples || 0;
        document.getElementById('statAnswered').textContent = st.stats?.questions_answered || 0;
        document.getElementById('statOpen').textContent = st.stats?.questions_open || 0;

        // AGI mode + fase din√¢mica
        const agiPct = Number(st.agi?.agi_mode_percent || 0);
        let phase = 'üßí Fase 1 ‚Äî Beb√™';
        if (agiPct >= 75) phase = 'üß† Fase 4 ‚Äî Adulta';
        else if (agiPct >= 55) phase = 'üßë Fase 3 ‚Äî Adolescente';
        else if (agiPct >= 35) phase = 'üßí Fase 2 ‚Äî Crian√ßa';
        const pb = document.getElementById('phaseBadge');
        if (pb) pb.textContent = `${phase} (AGI ${agiPct.toFixed(1)}%)`;

        const budget = aut?.budget || {};
        const state = aut?.state || {};
        const cbUntil = Number(state.circuit_open_until || 0);
        const nowMono = Math.floor(Date.now()/1000);
        const breaker = cbUntil > nowMono ? `ON (${cbUntil-nowMono}s)` : 'OFF';
        const ao = document.getElementById('autonomyOps');
        if (ao) {
          const dq = Number(meta?.decision_quality || 0).toFixed(2);
          const stuck = Number(meta?.stuck_cycles || 0);
          const replans = Number(meta?.replans || 0);
          const avgBench = Number(bench?.avg_score || 0).toFixed(1);
          const hist = (bench?.history || []).map(h => Number(h.score||0).toFixed(0)).join(',');
          ao.textContent = `Autonomia: budget ${budget.used_last_minute||0}/${budget.per_minute||'-'} por min ‚Ä¢ queued ${aut.queued||0} ‚Ä¢ expired ${aut.expired_recent||0} ‚Ä¢ circuit breaker ${breaker} ‚Ä¢ metacog q=${dq}, stuck=${stuck}, replans=${replans} ‚Ä¢ benchmark avg7=${avgBench}% [${hist}] ‚Ä¢ mem√≥ria: uncurated ${mem.uncurated||0}, archived ${mem.archived||0}, distilled ${mem.distilled||0}`;
        }
        const req = benchStatus?.requirements_1_8 || {};
        const reqAvg = Number(benchStatus?.requirements_avg_1_8 || 0).toFixed(1);
        const rs = document.getElementById('reqScores');
        if (rs) {
          const small = Object.entries(req).map(([k,v]) => `${k.replace(/^[0-9]+_/, '').slice(0,12)}=${Number(v||0).toFixed(0)}%`).join(' ‚Ä¢ ');
          const s3 = benchStatus?.sprint3_signals || {};
          const langTrend = (bench?.history || []).map(h => Number(((h.sprint3_signals||{}).language_eval_accuracy||0)*100).toFixed(0)).join(',');
          rs.textContent = `Requisitos 1-8 avg=${reqAvg}% ‚Ä¢ ${small || 'rode /api/agi/benchmark/run'} ‚Ä¢ Sprint3(lang_acc=${Number((s3.language_eval_accuracy||0)*100).toFixed(0)}%, dom_div=${s3.domain_diversity||0}, trend=[${langTrend}])`;
        }
        const s2 = document.getElementById('sprint2Health');
        if (s2) {
          const t = sprint2?.tom_ab || {};
          const m = sprint2?.milestones || {};
          s2.textContent = `Sprint2: ToM A/B lift=${Number(t.lift||0).toFixed(2)} (${t.label||'-'}) ‚Ä¢ milestones done=${m.milestones_done||0}/${m.milestones_total||0} throughput=${Number((m.throughput_done_rate||0)*100).toFixed(0)}% delayed=${m.delayed_open||0} replan_rate=${Number((m.replan_rate||0)*100).toFixed(0)}%`;
        }
        
        const tom = st.tom || {};
        const tomEl = document.getElementById('tomIntent');
        if (tomEl && tom.label) {
          tomEl.innerHTML = `
            <div><span class="tag tag-purple">${escHtml(tom.label)}</span> <span class="muted">conf=${Number(tom.confidence || 0).toFixed(2)}</span></div>
            <div style="margin-top:8px">${escHtml(tom.rationale || '')}</div>
          `;
        }

        currentQ = st.next;
        if (currentQ) {
          document.getElementById('questionText').textContent = currentQ.question;
          const meta = [];
          if (currentQ.priority) meta.push('priority=' + currentQ.priority);
          if (currentQ.template_id) meta.push('template=' + currentQ.template_id);
          if (currentQ.concept) meta.push('concept=' + currentQ.concept);
          if (currentQ.context) meta.push('contexto: ' + currentQ.context.slice(0, 100));
          document.getElementById('questionMeta').textContent = meta.join(' ‚Ä¢ ');
        } else {
          document.getElementById('questionText').textContent = '(nenhuma pergunta aberta)';
          document.getElementById('questionMeta').textContent = '';
        }

        // keep conflicts counter/preview fresh even outside conflicts tab
        loadConflictsSummary();
      } catch (e) {
        console.error('loadStatus error:', e);
      }
    }

    async function refreshQuestions() {
      try {
        const r = await api('/api/curiosity/refresh?target_count=5', { method: 'POST' });
        showToast(`‚úÖ Perguntas atualizadas (+${r.new_questions || 0}, abertas=${r.open_questions || 0})`);
        await loadStatus();
        await loadCuriosityQueue();
      } catch (e) {
        showToast('‚ùå ' + e.message, 'error');
      }
    }

    async function submitAnswer() {
      if (!currentQ) return;
      const ans = document.getElementById('answerInput').value;
      if (!ans.trim()) return showToast('Digite uma resposta', 'error');
      
      try {
        const r = await api('/api/answer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question_id: currentQ.id, answer: ans })
        });
        document.getElementById('answerInput').value = '';
        showToast(`‚úÖ Resposta salva (${r.triples_added} triplas extra√≠das)`);
        await loadStatus();
      } catch (e) {
        showToast('‚ùå ' + e.message, 'error');
      }
    }

    async function skipQuestion() {
      if (!currentQ) return;
      try {
        await api('/api/dismiss', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question_id: currentQ.id })
        });
        showToast('‚Üí Pergunta pulada');
        await loadStatus();
      } catch (e) {
        showToast('‚ùå ' + e.message, 'error');
      }
    }

    // === Ingest ===
    async function ingestExperience() {
      const text = document.getElementById('expInput').value;
      if (!text.trim()) return showToast('Digite algo para ensinar', 'error');
      
      const source = document.getElementById('sourceInput').value || null;
      const modality = document.getElementById('modalityInput').value;
      
      try {
        await api('/api/ingest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, source_id: source, modality })
        });
        document.getElementById('expInput').value = '';
        showToast('‚úÖ Experi√™ncia ingerida');
        await loadStatus();
      } catch (e) {
        showToast('‚ùå ' + e.message, 'error');
      }
    }

    async function uploadFile() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return showToast('Selecione um arquivo', 'error');
      
      const form = new FormData();
      form.append('file', file);
      
      try {
        const r = await api('/api/ingest/file', { method: 'POST', body: form });
        showToast(`‚úÖ Arquivo processado (${r.modality})`);
        await loadStatus();
      } catch (e) {
        showToast('‚ùå ' + e.message, 'error');
      }
    }

    // === Feed ===
    let lastEventId = 0;
    let sse = null;

    function appendFeedEvents(events) {
      if (!events || !events.length) return;
      const feed = document.getElementById('feed');
      if (!feed) return;

      if (feed.innerHTML === '(aguardando eventos...)') feed.innerHTML = '';

      const frag = document.createDocumentFragment();
      for (const e of events) {
        const ts = new Date((e.created_at || 0) * 1000).toLocaleTimeString();
        const div = document.createElement('div');
        div.className = 'feed-item';
        div.innerHTML = `<span class="time">[${ts}]</span> <span class="kind">${escHtml(e.kind || 'event')}:</span> ${escHtml(e.text || '')}`;
        frag.appendChild(div);
      }
      feed.appendChild(frag);

      // cap DOM nodes to avoid browser freeze on long sessions
      const maxItems = 250;
      while (feed.children.length > maxItems) {
        feed.removeChild(feed.firstChild);
      }

      feed.scrollTop = feed.scrollHeight;
      lastEventId = Math.max(lastEventId, ...events.map(e => Number(e.id || 0)));
    }

    async function loadFeed() {
      try {
        const j = await api('/api/events?since_id=' + lastEventId + '&limit=50');
        appendFeedEvents(j.events || []);
      } catch (e) {
        console.error('loadFeed error:', e);
      }
    }

    function startEventStream() {
      try {
        if (sse) {
          sse.close();
          sse = null;
        }
        sse = new EventSource('/api/stream/events?since_id=' + lastEventId + '&heartbeat_sec=10');

        sse.addEventListener('event', (ev) => {
          try {
            const d = JSON.parse(ev.data || '{}');
            appendFeedEvents([d]);
          } catch (_) {}
        });

        sse.addEventListener('insight', (ev) => {
          try {
            const d = JSON.parse(ev.data || '{}');
            appendFeedEvents([d]);
            showToast('üí° ' + (d.text || 'Novo insight'));
          } catch (_) {}
        });

        sse.addEventListener('error', () => {
          // fallback silencioso para polling
          console.warn('SSE disconnected; polling fallback remains active');
        });
      } catch (e) {
        console.warn('SSE start failed:', e);
      }
    }

    // === Graph ===
    let network = null;
    let nodeData = null;
    let edgeData = null;
    let nodeIdByLabel = new Map();
    let lastTripleId = 0;
    let edgeKeySet = new Set();

    function initGraph() {
      if (network) return;
      
      nodeData = new vis.DataSet([]);
      edgeData = new vis.DataSet([]);
      
      network = new vis.Network(document.getElementById('graph'), 
        { nodes: nodeData, edges: edgeData }, 
        {
          nodes: { shape: 'dot', size: 14, font: { color: '#e5e7eb', size: 12 } },
          edges: { color: '#64748b', font: { align: 'middle', color: '#94a3b8', size: 10 }, arrows: { to: { enabled: true, scaleFactor: 0.5 } } },
          physics: { stabilization: false, barnesHut: { gravitationalConstant: -15000, springLength: 140 } }
        }
      );
      
      graphTick();
    }

    function nid(label) {
      label = (label || '').trim() || '(vazio)';
      if (nodeIdByLabel.has(label)) return nodeIdByLabel.get(label);
      
      const id = 'n' + (nodeIdByLabel.size + 1);
      nodeIdByLabel.set(label, id);
      
      const isNorm = label === 'AGI';
      const color = isNorm ? { background: '#8b5cf6', border: '#6d28d9' } : { background: '#3b82f6', border: '#1d4ed8' };
      
      nodeData.add({ id, label, _type: isNorm ? 'norm' : 'fact', color, size: isNorm ? 16 : 12 });
      return id;
    }

    async function graphTick() {
      try {
        if (document.hidden) return;
        const j = await api('/api/graph/triples?since_id=' + lastTripleId + '&limit=180', { timeoutMs: 7000 });
        const triples = j.triples || [];

        for (const t of triples) {
          lastTripleId = Math.max(lastTripleId, t.id || 0);
          const a = nid(t.subject);
          const b = nid(t.object);

          const key = a + '|' + t.predicate + '|' + b;
          if (edgeKeySet.has(key)) continue;
          edgeKeySet.add(key);

          edgeData.add({ id: 'e' + edgeKeySet.size, from: a, to: b, label: t.predicate });
        }

        // cap graph size to prevent memory spikes
        const maxNodes = 600;
        const maxEdges = 1200;
        if (nodeData.length > maxNodes) {
          const ids = nodeData.getIds();
          nodeData.remove(ids.slice(0, nodeData.length - maxNodes));
        }
        if (edgeData.length > maxEdges) {
          const ids = edgeData.getIds();
          edgeData.remove(ids.slice(0, edgeData.length - maxEdges));
        }

        document.getElementById('graphStats').textContent = `n√≥s=${nodeData.length} arestas=${edgeData.length}`;
      } catch (e) {
        console.error('graphTick error:', e);
      }
    }

    // === Sources ===
    async function loadSources() {
      try {
        const j = await api('/api/sources?limit=50');
        const sources = j.sources || [];
        
        document.getElementById('statSources').textContent = sources.length;
        
        if (!sources.length) {
          document.getElementById('sourcesList').innerHTML = '<div class="muted">(nenhuma fonte registrada)</div>';
          return;
        }
        
        document.getElementById('sourcesList').innerHTML = sources.map(s => {
          const trust = (s.trust || 0.5);
          const trustPct = Math.round(trust * 100);
          const trustClass = trust >= 0.7 ? 'trust-high' : trust >= 0.4 ? 'trust-medium' : 'trust-low';
          
          return `
            <div class="list-item">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <code>${escHtml(s.id)}</code>
                  <span class="tag tag-blue" style="margin-left: 8px;">${s.kind || 'unknown'}</span>
                </div>
                <div class="muted">
                  ‚úì ${s.support_count || 0} / ‚úó ${s.contradict_count || 0}
                </div>
              </div>
              <div class="trust-bar">
                <div class="trust-fill ${trustClass}" style="width: ${trustPct}%"></div>
              </div>
              <div class="muted" style="margin-top: 4px;">Trust: ${trustPct}%</div>
            </div>
          `;
        }).join('');
      } catch (e) {
        showToast('‚ùå ' + e.message, 'error');
      }
    }

    // === Curiosity Stats ===
    async function loadCuriosityStats() {
      try {
        const j = await api('/api/curiosity/stats');
        const stats = j.stats || {};
        
        document.getElementById('curTemplates').textContent = stats.total_templates || 0;
        document.getElementById('curConcepts').textContent = stats.concepts_tracked || 0;
        document.getElementById('curDefined').textContent = stats.concepts_defined || 0;
        
        // Gaps
        const gaps = stats.top_gaps || [];
        document.getElementById('gapsList').innerHTML = gaps.length 
          ? gaps.map(g => `<span class="tag tag-orange" style="margin: 4px;">${escHtml(g)}</span>`).join('')
          : '<span class="muted">(nenhuma lacuna detectada)</span>';
        
        // Templates
        const templates = stats.templates || [];
        document.getElementById('templatesList').innerHTML = templates.map(t => {
          const effPct = Math.round((t.effectiveness || 0.5) * 100);
          return `
            <div class="list-item">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <code>${escHtml(t.pattern)}</code>
                <span class="tag tag-purple">${t.category}</span>
              </div>
              <div class="eff-bar">
                <div class="eff-bar-track">
                  <div class="eff-bar-fill" style="width: ${effPct}%"></div>
                </div>
                <div class="eff-value">${effPct}%</div>
              </div>
              <div class="muted" style="margin-top: 4px;">
                ‚úì ${t.success || 0} / ‚úó ${t.failure || 0} | ${t.triples || 0} triplas geradas
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        showToast('‚ùå ' + e.message, 'error');
      }
    }

    async function loadCuriosityQueue() {
      try {
        const j = await api('/api/curiosity/queue?limit=20');
        const items = j.items || [];
        const el = document.getElementById('curQueueList');
        if (!el) return;
        if (!items.length) {
          el.innerHTML = '<div class="muted">(fila vazia)</div>';
          return;
        }
        el.innerHTML = items.map(q => `
          <div class="list-item">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
              <strong>${escHtml(q.question || '')}</strong>
              <span class="tag tag-blue">p=${q.priority || 0}</span>
            </div>
            <div class="muted" style="margin-top:6px;">template=${escHtml(q.template_id || '-')} ‚Ä¢ concept=${escHtml(q.concept || '-')}</div>
          </div>
        `).join('');
      } catch (e) {
        showToast('‚ùå ' + e.message, 'error');
      }
    }

    // === Conflicts ===
    async function loadConflictsSummary() {
      try {
        const j = await api('/api/conflicts?status=open&limit=30', { timeoutMs: 7000 });
        const conflicts = j.conflicts || [];

        const stat = document.getElementById('statConflicts');
        if (stat) stat.textContent = conflicts.length;

        const el = document.getElementById('conflictsPreview');
        if (!el) return;
        if (!conflicts.length) {
          el.innerHTML = 'Conflitos: nenhum aberto ‚úÖ';
          return;
        }
        const line = conflicts.slice(0, 3).map(c => `#${c.id} ${escHtml(c.subject || '')} ${escHtml(c.predicate || '')}`).join(' ‚Ä¢ ');
        el.innerHTML = `Conflitos abertos: <strong>${conflicts.length}</strong> ‚Äî ${line}`;
      } catch (e) {
        const el = document.getElementById('conflictsPreview');
        if (el) el.innerHTML = `Conflitos: erro ao carregar (${escHtml(e.message)})`;
      }
    }

    async function loadMissionPreview() {
      try {
        const [tasksRes, actRes] = await Promise.all([
          api('/api/mission/tasks?limit=80', { timeoutMs: 7000 }),
          api('/api/mission/activities?limit=40', { timeoutMs: 7000 }),
        ]);
        const tasks = tasksRes.tasks || [];
        const act = actRes.activities || [];
        const by = { inbox:0, assigned:0, in_progress:0, review:0, done:0, blocked:0 };
        tasks.forEach(t => { const s = t.status || 'inbox'; if (by[s] !== undefined) by[s] += 1; });
        const last = (act[act.length-1] || {}).text || 'sem atividade recente';
        const el = document.getElementById('missionPreview');
        if (!el) return;
        el.innerHTML = `Mission Control ‚Äî inbox:${by.inbox} ‚Ä¢ assigned:${by.assigned} ‚Ä¢ in_progress:${by.in_progress} ‚Ä¢ review:${by.review} ‚Ä¢ blocked:${by.blocked} ‚Ä¢ done:${by.done} | √∫ltimo: ${escHtml(String(last).slice(0,100))}`;
      } catch (e) {
        const el = document.getElementById('missionPreview');
        if (el) el.innerHTML = `Mission Control: erro (${escHtml(e.message)})`;
      }
    }

    async function loadConflicts() {
      try {
        const j = await api('/api/conflicts?status=open&limit=20');
        const conflicts = j.conflicts || [];
        
        document.getElementById('statConflicts').textContent = conflicts.length;
        
        if (!conflicts.length) {
          document.getElementById('conflictsList').innerHTML = '<div class="muted">(nenhum conflito aberto)</div>';
          return;
        }
        
        // Load full details in parallel (bounded)
        const limited = conflicts.slice(0, 12);
        const detailResults = await Promise.allSettled(
          limited.map(c => api('/api/conflicts/' + c.id, { timeoutMs: 7000 }))
        );
        const full = detailResults.map((r, i) => (r.status === 'fulfilled' ? r.value.conflict : limited[i]));
        
        document.getElementById('conflictsList').innerHTML = full.map(c => {
          const vars = c.variants || [];
          
          return `
            <div class="conflict-card">
              <div class="conflict-header">
                <span class="tag tag-orange">#${c.id}</span>
                <code>${escHtml(c.subject)}</code>
                <code>${escHtml(c.predicate)}</code>
                <span class="muted">seen=${c.seen_count || 0}</span>
              </div>
              <div class="muted" style="margin-bottom: 12px;">${escHtml(c.last_summary || '')}</div>
              
              ${vars.map(v => `
                <label class="variant-option">
                  <input type="radio" name="c${c.id}_choice" value="${escHtml(v.object)}">
                  <strong>${escHtml(v.object)}</strong>
                  <span class="muted">(conf=${(v.confidence || 0).toFixed(2)})</span>
                </label>
              `).join('')}
              
              <input type="text" id="c${c.id}_by" placeholder="Decidido por..." style="margin-top: 12px;">
              <textarea id="c${c.id}_res" rows="2" placeholder="Justificativa..." style="margin-top: 8px;"></textarea>
              
              <div class="btn-group" style="margin-top: 12px;">
                <button class="btn btn-sm" onclick="resolveConflict(${c.id})">‚úì Resolver</button>
                <button class="btn btn-sm btn-secondary" onclick="archiveConflict(${c.id})">üì¶ Arquivar</button>
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        showToast('‚ùå ' + e.message, 'error');
      }
    }

    async function autoResolveConflicts() {
      const btn = document.querySelector('button[onclick="autoResolveConflicts()"]');
      const statusDiv = document.getElementById('autoResolveStatus');
      
      try {
        btn.disabled = true;
        btn.textContent = '‚è≥ Resolvendo...';
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<span class="muted">Analisando conflitos com LLM... isso pode levar alguns segundos.</span>';
        
        const r = await api('/api/conflicts/auto-resolve', { method: 'POST' });
        
        let html = `<div><strong>Resultado:</strong> ${r.resolved} resolvidos, ${r.needs_human} precisam de humano.</div>`;
        if (r.results && r.results.length) {
          html += '<ul style="margin-top:8px;padding-left:20px;font-size:13px">';
          r.results.forEach(res => {
            const icon = res.resolved ? '‚úÖ' : (res.needs_human ? 'üë§' : '‚ö†Ô∏è');
            html += `<li>${icon} <strong>${escHtml(res.subject)}</strong>: ${escHtml(res.reasoning)}</li>`;
          });
          html += '</ul>';
        } else {
          html += '<div class="muted" style="margin-top:4px">Nenhum conflito eleg√≠vel para auto-resolu√ß√£o no momento (cooldown ou insuficientes).</div>';
        }
        
        statusDiv.innerHTML = html;
        showToast('Processo finalizado');
        await loadConflicts();
        await loadStatus();
        
      } catch (e) {
        statusDiv.innerHTML = `<span style="color:var(--accent-red)">Erro: ${escHtml(e.message)}</span>`;
        showToast('Erro na auto-resolu√ß√£o', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'ü§ñ Auto-resolver';
      }
    }

    async function resolveConflict(id) {
      const sel = document.querySelector(`input[name="c${id}_choice"]:checked`);
      if (!sel) return showToast('Escolha uma variante', 'error');
      
      try {
        await api('/api/conflicts/' + id + '/resolve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chosen_object: sel.value,
            decided_by: document.getElementById('c' + id + '_by').value || null,
            resolution: document.getElementById('c' + id + '_res').value || null
          })
        });
        showToast('‚úÖ Conflito resolvido');
        await loadConflicts();
        await loadStatus();
      } catch (e) {
        showToast('‚ùå ' + e.message, 'error');
      }
    }

    async function archiveConflict(id) {
      try {
        await api('/api/conflicts/' + id + '/archive', { method: 'POST' });
        showToast('üì¶ Conflito arquivado');
        await loadConflicts();
      } catch (e) {
        showToast('‚ùå ' + e.message, 'error');
      }
    }

    // === Search ===
    async function doSearch() {
      const q = document.getElementById('searchInput').value;
      if (!q.trim()) return;
      
      try {
        const j = await api('/api/search/semantic', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: q, top_k: 10 })
        });
        
        const results = j.results || [];
        if (!results.length) {
          document.getElementById('searchResults').innerHTML = '<div class="muted">Nenhum resultado encontrado.</div>';
          return;
        }
        
        document.getElementById('searchResults').innerHTML = results.map(r => {
          if (r.type === 'experience') {
            return `
              <div class="search-result">
                <div style="display: flex; justify-content: space-between;">
                  <span class="tag tag-blue">Experi√™ncia</span>
                  <span class="search-score">${(r.score || 0).toFixed(3)}</span>
                </div>
                <div style="margin-top: 8px;">${escHtml(r.text)}</div>
                <div class="muted">${escHtml(r.source_id || '')}</div>
              </div>
            `;
          } else {
            return `
              <div class="search-result">
                <div style="display: flex; justify-content: space-between;">
                  <span class="tag tag-purple">Tripla</span>
                  <span class="search-score">${(r.score || 0).toFixed(3)}</span>
                </div>
                <div style="margin-top: 8px;">
                  <code>${escHtml(r.subject)}</code> 
                  <strong>${escHtml(r.predicate)}</strong> 
                  <code>${escHtml(r.object)}</code>
                </div>
              </div>
            `;
          }
        }).join('');
      } catch (e) {
        showToast('‚ùå ' + e.message, 'error');
      }
    }

    // === Goal Curriculum + ToM + Long Horizon ===
    async function loadTomStatus() {
      try {
        const t = await api('/api/tom/status?limit=30');
        const el = document.getElementById('tomIntent');
        if (!el) return;
        el.innerHTML = `
          <div><span class="tag tag-purple">${escHtml(t.label || 'unknown')}</span> <span class="muted">conf=${Number(t.confidence || 0).toFixed(2)}</span></div>
          <div style="margin-top:8px">${escHtml(t.rationale || '')}</div>
          <div class="muted" style="margin-top:8px">${escHtml((t.evidence_excerpt || '').slice(0,160))}</div>
        `;
      } catch (e) {
        const el = document.getElementById('tomIntent');
        if (el) el.innerHTML = `<span style="color:var(--accent-red)">Erro ToM: ${escHtml(e.message)}</span>`;
      }
    }

    async function loadHorizonStatus() {
      try {
        const hz = await api('/api/horizon/missions?limit=12', { timeoutMs: 9000 });
        const el = document.getElementById('horizonMission');
        if (!el) return;

        const active = hz.active;
        if (!active) {
          el.innerHTML = '<div class="muted">(sem miss√£o ativa)</div>';
          return;
        }

        const cps = (active.checkpoints || []).slice(-5).reverse();
        const cpHtml = cps.length
          ? cps.map(c => `<div class="list-item"><div><span class="tag tag-purple">${escHtml(c.signal || 'checkpoint')}</span> <span class="muted">${new Date((Number(c.ts)||0)*1000).toLocaleString()}</span></div><div style="margin-top:6px">${escHtml(c.note || '')}</div></div>`).join('')
          : '<div class="muted">Sem checkpoints ainda.</div>';

        const progressPct = Math.round(Number(active.progress || 0) * 100);
        const dueStr = active.due_at ? new Date(Number(active.due_at) * 1000).toLocaleString() : '-';

        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;">
            <div>
              <div><strong>${escHtml(active.title || 'Miss√£o')}</strong></div>
              <div class="muted" style="margin-top:6px">${escHtml(active.objective || '')}</div>
              <div class="muted" style="margin-top:6px">Prazo: ${escHtml(dueStr)} ‚Ä¢ Horizonte: ${Number(active.horizon_days || 0)}d</div>
            </div>
            <div class="tag tag-blue">${progressPct}%</div>
          </div>
          <div class="trust-bar" style="margin-top:10px"><div class="trust-fill trust-high" style="width:${progressPct}%"></div></div>
          <div style="margin-top:10px">
            <button class="btn btn-sm btn-secondary" onclick="runHorizonReview()">üåÄ Rodar review</button>
          </div>
          <div style="margin-top:12px">${cpHtml}</div>
        `;
      } catch (e) {
        const el = document.getElementById('horizonMission');
        if (el) el.innerHTML = `<span style="color:var(--accent-red)">Erro horizonte: ${escHtml(e.message)}</span>`;
      }
    }

    async function runHorizonReview() {
      try {
        await api('/api/horizon/review', { method: 'POST', timeoutMs: 12000 });
        showToast('‚úÖ Review de horizonte executado');
        await loadHorizonStatus();
      } catch (e) {
        showToast('‚ùå ' + e.message, 'error');
      }
    }

    async function loadPersonaStatus() {
      try {
        const st = await api('/api/persona/status', { timeoutMs: 9000 });
        const ex = await api('/api/persona/examples?limit=20', { timeoutMs: 9000 });
        const runtime = st.runtime || {};
        const cfg = st.config || {};

        const statusEl = document.getElementById('personaStatus');
        const examplesEl = document.getElementById('personaExamples');
        if (statusEl) {
          statusEl.innerHTML = `
            <div><span class="tag tag-purple">valence=${Number(runtime.valence || 0).toFixed(2)}</span> <span class="tag tag-blue">arousal=${Number(runtime.arousal || 0).toFixed(2)}</span></div>
            <div style="margin-top:6px"><strong>Goal:</strong> ${escHtml(runtime.active_goal || 'none')}</div>
            <div class="muted" style="margin-top:4px"><strong>Purpose:</strong> ${escHtml(runtime.purpose || '')}</div>
            <div class="muted" style="margin-top:4px">examples=${Number(runtime.example_count || 0)}</div>
          `;
        }

        const tone = document.getElementById('personaTone');
        const k = document.getElementById('personaFewShot');
        if (tone) tone.value = cfg.desired_tone || '';
        if (k) k.value = Number(cfg.few_shot_k || 3);

        const items = (ex.items || []).slice().sort((a, b) => Number(b.score || 0) - Number(a.score || 0));
        if (examplesEl) {
          examplesEl.innerHTML = items.slice(0, 5).map(it => `
            <div class="list-item">
              <div style="display:flex;justify-content:space-between;gap:8px;">
                <span class="tag tag-green">score=${Number(it.score || 0).toFixed(2)}</span>
                <span class="muted">${escHtml(it.tone || '')}</span>
              </div>
              <div style="margin-top:6px">${escHtml((it.assistant || '').slice(0, 140))}</div>
            </div>
          `).join('') || '<span class="muted">Sem exemplos ainda.</span>';
        }
      } catch (e) {
        const statusEl = document.getElementById('personaStatus');
        if (statusEl) statusEl.innerHTML = `<span style="color:var(--accent-red)">Erro persona: ${escHtml(e.message)}</span>`;
      }
    }

    async function savePersonaConfig() {
      try {
        const tone = (document.getElementById('personaTone')?.value || '').trim();
        const k = Number(document.getElementById('personaFewShot')?.value || 3);
        await api('/api/persona/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ config: { desired_tone: tone, few_shot_k: Math.max(1, Math.min(6, k)) } })
        });
        showToast('‚úÖ Persona atualizada');
        await loadPersonaStatus();
      } catch (e) {
        showToast('‚ùå ' + e.message, 'error');
      }
    }

    async function loadGoalCurriculum() {
      try {
        const gs = await api('/api/goals?status=all&limit=50');
        const active = gs.active;
        const el = document.getElementById('goalCurriculum');
        if (!el) return;
        if (!active) {
          el.innerHTML = '<div class="muted">(sem goal ativo)</div>';
          return;
        }

        const gId = active.id;
        const ms = await api(`/api/goals/${gId}/milestones?limit=20`);
        const arr = ms.milestones || [];
        if (!arr.length) {
          el.innerHTML = `
            <div><strong>${escHtml(active.title || 'Goal')}</strong></div>
            <div class="muted" style="margin-top:8px">Sem milestones ainda.</div>
            <div style="margin-top:10px"><button class="btn btn-sm btn-secondary" onclick="ensureMilestones(${gId})">üß© Gerar curr√≠culo semanal</button></div>
          `;
          return;
        }

        const next = ms.next;
        const items = arr.map(m => {
          const p = Math.round(Number(m.progress || 0) * 100);
          const isNext = next && Number(next.id) === Number(m.id);
          return `
            <div class="list-item">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                <div><strong>W${m.week_index}</strong> ‚Äî ${escHtml(m.title || '')} ${isNext ? '<span class="tag tag-green" style="margin-left:8px">next</span>' : ''}</div>
                <span class="tag tag-blue">${p}%</span>
              </div>
              <div class="muted" style="margin-top:6px">${escHtml(m.progress_criteria || '')}</div>
              <div class="trust-bar" style="margin-top:8px"><div class="trust-fill trust-high" style="width:${p}%"></div></div>
              ${isNext ? `<div style="margin-top:8px"><button class="btn btn-sm" onclick="advanceMilestone(${m.id}, ${Math.min(1, (Number(m.progress||0)+0.25)).toFixed(2)})">‚¨ÜÔ∏è Avan√ßar +25%</button></div>` : ''}
            </div>
          `;
        }).join('');

        el.innerHTML = `
          <div style="margin-bottom:10px"><strong>${escHtml(active.title || 'Goal')}</strong></div>
          ${items}
        `;
      } catch (e) {
        const el = document.getElementById('goalCurriculum');
        if (el) el.innerHTML = `<span style="color:var(--accent-red)">Erro curr√≠culo: ${escHtml(e.message)}</span>`;
      }
    }

    async function ensureMilestones(goalId) {
      try {
        await api(`/api/goals/${goalId}/milestones/ensure?weeks=4`, { method: 'POST' });
        showToast('‚úÖ Curr√≠culo semanal gerado');
        await loadGoalCurriculum();
      } catch (e) {
        showToast('‚ùå ' + e.message, 'error');
      }
    }

    async function advanceMilestone(mid, progress) {
      try {
        await api(`/api/milestones/${mid}/progress`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ progress })
        });
        showToast('‚úÖ Milestone atualizado');
        await loadGoalCurriculum();
      } catch (e) {
        showToast('‚ùå ' + e.message, 'error');
      }
    }

    // === Utils ===
    function escHtml(s) {
      return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // === Insights ===
    async function loadInsights() {
      try {
        const q = (document.getElementById('insightSearch')?.value || '').trim();
        const url = q ? ('/api/insights?limit=80&query=' + encodeURIComponent(q)) : '/api/insights?limit=80';
        const j = await api(url);
        const items = j.insights || [];
        const el = document.getElementById('insightsList');
        if (!items.length) {
          el.innerHTML = '<div class="muted">(nenhum insight ainda)</div>';
          return;
        }
        el.innerHTML = items.map(i => {
          const ts = new Date((i.created_at || 0) * 1000).toLocaleString();
          return `
            <div class="list-item">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
                <strong>${escHtml(i.title || 'Insight')}</strong>
                <span class="tag tag-purple">${escHtml(i.kind || 'insight')}</span>
              </div>
              <div style="margin-top:6px;">${escHtml(i.text || '')}</div>
              <div class="muted" style="margin-top:6px;">${ts}</div>
            </div>
          `;
        }).join('');
      } catch (e) {
        showToast('‚ùå ' + e.message, 'error');
      }
    }

    // === Settings ===
    async function loadSettings() {
      try {
        const r = await api('/api/settings');
        const s = r.settings || {};
        const form = document.getElementById('settingsForm');
        
        // Fill form
        for (const k in s) {
          if (form[k]) {
            // If it's a key, show placeholder if set
            if (k.includes('key') && s[k]) {
               form[k].placeholder = "Configurada (" + s[k] + ")";
               form[k].value = ""; // Clear value for security
            } else {
               form[k].value = s[k];
            }
          }
        }
      } catch (e) {
        showToast('Erro ao carregar settings: ' + e.message, 'error');
      }
    }

    document.getElementById('settingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const data = {};
      
      // Only send fields that have values (user typed something)
      new FormData(form).forEach((value, key) => {
        if (value.trim()) data[key] = value.trim();
      });
      
      try {
        await api('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        showToast('‚úÖ Configura√ß√µes salvas com sucesso!');
        loadSettings(); // Reload to update placeholders
      } catch (e) {
        showToast('‚ùå Erro ao salvar: ' + e.message, 'error');
      }
    });

    // === Init ===
    loadStatus();
    loadSources();
    loadGoalCurriculum();
    loadTomStatus();
    loadHorizonStatus();
    loadPersonaStatus();
    loadConflictsSummary();
    loadMissionPreview();
    loadFeed();
    startEventStream();

    let statusIntervalMs = 5000;
    let graphIntervalMs = 3000;
    let slowIntervalMs = 15000;
    let _timers = [];

    function clearTimers() {
      _timers.forEach(t => clearInterval(t));
      _timers = [];
    }

    function setupTimers() {
      clearTimers();
      _timers.push(setInterval(loadStatus, statusIntervalMs));
      _timers.push(setInterval(loadFeed, statusIntervalMs)); // fallback in case SSE drops
      _timers.push(setInterval(() => { if (network) graphTick(); }, graphIntervalMs));
      _timers.push(setInterval(loadGoalCurriculum, slowIntervalMs));
      _timers.push(setInterval(loadTomStatus, slowIntervalMs));
      _timers.push(setInterval(loadHorizonStatus, slowIntervalMs));
      _timers.push(setInterval(loadPersonaStatus, slowIntervalMs));
      _timers.push(setInterval(loadConflictsSummary, slowIntervalMs));
      _timers.push(setInterval(loadMissionPreview, slowIntervalMs));
    }

    function updatePollingMode() {
      if (document.hidden) {
        statusIntervalMs = 20000;
        graphIntervalMs = 20000;
        slowIntervalMs = 45000;
      } else {
        statusIntervalMs = 5000;
        graphIntervalMs = 4000;
        slowIntervalMs = 15000;
      }
      setupTimers();
    }

    document.addEventListener('visibilitychange', updatePollingMode);
    updatePollingMode();

    // Enter key for search
    document.getElementById('searchInput').addEventListener('keypress', e => {
      if (e.key === 'Enter') doSearch();
    });
    document.getElementById('insightSearch').addEventListener('keypress', e => {
      if (e.key === 'Enter') loadInsights();
    });
  </script>
</body>
</html>
